<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì… - Smart Spending</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow p-4" style="min-width: 450px;">
        <h3 class="text-center mb-4">ğŸ“ íšŒì›ê°€ì…</h3>

        <form id="signupForm">
            <!-- ì´ë©”ì¼ -->
            <div class="mb-3">
                <label class="form-label">ì´ë©”ì¼</label>
                <div class="input-group">
                    <input type="email" id="email" class="form-control" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="sendCode()">ì¸ì¦ì½”ë“œ</button>
                </div>
                <div id="emailFeedback" class="form-text text-success d-none">ì¸ì¦ì½”ë“œë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.</div>
            </div>

            <!-- ì¸ì¦ì½”ë“œ -->
            <div class="mb-3">
                <label class="form-label">ì¸ì¦ì½”ë“œ</label>
                <div class="input-group">
                    <input type="text" id="code" class="form-control" placeholder="6ìë¦¬ ì½”ë“œ">
                    <button type="button" class="btn btn-outline-primary" onclick="verifyCode()">í™•ì¸</button>
                </div>
                <div id="codeFeedback" class="form-text d-none"></div>
            </div>

            <!-- ì´ë¦„ -->
            <div class="mb-3">
                <label class="form-label">ì´ë¦„</label>
                <input type="text" id="name" class="form-control" required>
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ -->
            <div class="mb-3">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" class="form-control" required>
                <div id="passwordFeedback" class="form-text text-danger d-none">
                    ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
            <div class="mb-3">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPassword" class="form-control" required>
                <div id="passwordMatchFeedback" class="form-text text-danger d-none">
                    ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            </div>

            <!-- ê°€ì… ë²„íŠ¼ -->
            <button type="submit" class="btn btn-success w-100" id="submitBtn" disabled>ê°€ì…í•˜ê¸°</button>
        </form>

        <div class="mt-3 text-center">
            <a th:href="@{/login}">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?</a>
        </div>
    </div>
</div>

<script>
    let emailVerified = false;

    async function sendCode() {
        const email = document.getElementById("email").value.trim();
        const feedback = document.getElementById("emailFeedback");

        const dupCheck = await fetch(`/user/register/check-email?email=${encodeURIComponent(email)}`);
        const isDuplicated = await dupCheck.json();
        if (isDuplicated.result) {
            alert("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
            return;
        }

        const res = await fetch(`/user/register/send-code?email=${encodeURIComponent(email)}`, {
            method: 'POST'
        });

        if (res.ok) {
            feedback.classList.remove("d-none", "text-danger");
            feedback.classList.add("text-success");
            feedback.textContent = "ì¸ì¦ì½”ë“œë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.";
        } else {
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            feedback.textContent = "ì¸ì¦ì½”ë“œ ì „ì†¡ ì‹¤íŒ¨";
        }
    }

    async function verifyCode() {
        const email = document.getElementById("email").value.trim();
        const code = document.getElementById("code").value.trim();
        const feedback = document.getElementById("codeFeedback");

        const res = await fetch("/user/register/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code })
        });

        if (!res.ok) {
            const error = await res.json();
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            feedback.textContent = error.message || "ì¸ì¦ ì‹¤íŒ¨. ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
            return;
        }

        const data = await res.json();
        if (data.data) {
            alert("ì¸ì¦ ì„±ê³µ!");
            emailVerified = true;
            document.getElementById("submitBtn").disabled = !isPasswordValid();
        }
    }

    function isPasswordValid() {
        const pw = document.getElementById("password").value.trim();
        const confirm = document.getElementById("confirmPassword").value.trim();
        const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

        const valid = regex.test(pw);
        const match = pw === confirm;

        document.getElementById("passwordFeedback").classList.toggle("d-none", valid);
        document.getElementById("passwordMatchFeedback").classList.toggle("d-none", match);

        return valid && match;
    }

    document.getElementById("password").addEventListener("input", () => {
        document.getElementById("submitBtn").disabled = !(emailVerified && isPasswordValid());
    });

    document.getElementById("confirmPassword").addEventListener("input", () => {
        document.getElementById("submitBtn").disabled = !(emailVerified && isPasswordValid());
    });

    document.getElementById("signupForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        const name = document.getElementById("name").value.trim();
        const password = document.getElementById("password").value.trim();

        const res = await fetch("/user/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, name, password })
        });

        if (res.ok) {
            alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = "/login";
        } else {
            const result = await res.json();
            alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (result.message || "ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”."));
        }
    });
</script>

</body>
</html>