<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Smart Spending</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            padding: 1.5rem;
            color: white;
        }
        .sidebar a {
            color: white;
            display: block;
            margin: 1rem 0;
            text-decoration: none;
        }
        .sidebar a:hover {
            text-decoration: underline;
        }
        .content {
            padding: 2rem;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 sidebar">
            <h4>Smart Spending</h4>
            <a href="/dashboard">ìš”ì•½</a>
            <a href="/transaction">ì§€ì¶œ/ìˆ˜ì…</a>
            <a href="/budget">ì˜ˆì‚°</a>
            <hr style="border-color: #666;">
            <a href="/logout" class="text-danger">ë¡œê·¸ì•„ì›ƒ</a>
        </nav>

        <!-- Main Dashboard Content -->
        <main class="col-md-10 content">
            <h2>ğŸ“… ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h2>

            <!-- ë‚ ì§œ ì„ íƒ -->
            <div class="d-flex gap-2 mb-4">
                <input type="date" id="startDate" class="form-control w-auto">
                <input type="date" id="endDate" class="form-control w-auto">
                <button class="btn btn-primary" onclick="loadDashboard()">ì¡°íšŒ</button>
            </div>

            <!-- 4êµ¬ì—­ -->
            <div class="row g-4">
                <!-- ìˆ˜ì…/ì§€ì¶œ ì°¨íŠ¸ -->
                <div class="col-md-6">
                    <div class="card p-3">
                        <h5>ğŸ’° ê¸°ê°„ë³„ ìˆ˜ì…/ì§€ì¶œ</h5>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ -->
                <div class="col-md-6">
                    <div class="card p-3">
                        <h5>ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h5>
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>

                <!-- ìˆ˜ì…/ì§€ì¶œ ìš”ì•½ -->
                <div class="col-md-6">
                    <div class="card p-3">
                        <h5>ğŸ“ˆ ìš”ì•½ ì •ë³´</h5>
                        <ul class="list-group list-group-flush" id="summaryList"></ul>
                    </div>
                </div>

                <!-- ìµœê·¼ ê±°ë˜ -->
                <div class="col-md-6">
                    <div class="card p-3">
                        <h5>ğŸ•’ ìµœê·¼ ê±°ë˜</h5>
                        <ul class="list-group list-group-flush" id="recentList"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login";
    }

    let barChartInstance = null;
    let pieChartInstance = null;

    async function loadDashboard() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const params = new URLSearchParams();

        if (startDate) params.append("startDate", startDate);
        if (endDate) params.append("endDate", endDate);

        const response = await fetch(`/dashboard/?${params.toString()}`, {
            headers: {
                Authorization: `Bearer ${accessToken}`
            }
        });

        if (!response.ok) {
            alert("ëŒ€ì‹œë³´ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        const result = await response.json();
        const data = result.data;

        drawBarChart(data.incomeExpenseByDate || []);
        drawPieChart(data.spendingByCategory || []);
        drawSummary(data.summary || {});
        drawRecent(data.recentTransactions || []);
    }

    function drawBarChart(data) {
        const ctx = document.getElementById('barChart').getContext('2d');
        if (barChartInstance) barChartInstance.destroy();

        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    {
                        label: 'ìˆ˜ì…',
                        data: data.map(d => d.income),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)'
                    },
                    {
                        label: 'ì§€ì¶œ',
                        data: data.map(d => d.expense),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    }
                ]
            }
        });
    }

    function drawPieChart(data) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChartInstance) pieChartInstance.destroy();

        pieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(d => d.categoryName),
                datasets: [{
                    data: data.map(d => d.amount),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#6f42c1', '#20c997']
                }]
            }
        });
    }

    function drawSummary(summary) {
        const ul = document.getElementById("summaryList");
        ul.innerHTML = `
      <li class="list-group-item">ì´ ìˆ˜ì…: ${Number(summary.totalIncome ?? 0).toLocaleString()}ì›</li>
      <li class="list-group-item">ì´ ì§€ì¶œ: ${Number(summary.totalExpense ?? 0).toLocaleString()}ì›</li>
      <li class="list-group-item">ì˜ˆì‚°: ${Number(summary.mainBudget ?? 0).toLocaleString()}ì›</li>
      <li class="list-group-item">ì”ì—¬ ì˜ˆì‚°: ${Number(summary.remainingBudget ?? 0).toLocaleString()}ì›</li>
      <li class="list-group-item">ìˆ˜ì… ë¹„ìœ¨: ${summary.incomePercentage ?? 0}%</li>
      <li class="list-group-item">ì§€ì¶œ ë¹„ìœ¨: ${summary.expensePercentage ?? 0}%</li>
    `;
    }

    function drawRecent(transactions) {
        const ul = document.getElementById("recentList");
        ul.innerHTML = transactions.map(tx =>
            `<li class="list-group-item">${tx.date} - [${tx.type === 'EXPENSE' ? 'ì§€ì¶œ' : 'ìˆ˜ì…'}] ${tx.category} ${Number(tx.amount).toLocaleString()}ì›</li>`
        ).join('');
    }

    // ë‚ ì§œ ì´ˆê¸°ê°’: ì´ë²ˆ ë‹¬ 1ì¼ ~ ë§ì¼
    window.onload = () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const lastDay = new Date(yyyy, mm, 0).getDate();

        document.getElementById("startDate").value = `${yyyy}-${mm}-01`;
        document.getElementById("endDate").value = `${yyyy}-${mm}-${lastDay}`;
        loadDashboard();
    }
</script>

</body>
</html>