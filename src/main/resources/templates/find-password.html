<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° - Smart Spending</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow p-4" style="min-width: 450px;">
        <h3 class="text-center mb-4">ğŸ” ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h3>

        <form id="resetForm">
            <!-- ì´ë©”ì¼ -->
            <div class="mb-3">
                <label class="form-label">ì´ë©”ì¼</label>
                <div class="input-group">
                    <input type="email" id="email" class="form-control" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="sendCode()">ì½”ë“œì „ì†¡</button>
                </div>
                <div id="emailFeedback" class="form-text d-none text-success">ì¸ì¦ì½”ë“œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
            </div>

            <!-- ì¸ì¦ì½”ë“œ -->
            <div class="mb-3">
                <label class="form-label">ì¸ì¦ì½”ë“œ</label>
                <div class="input-group">
                    <input type="text" id="code" class="form-control" placeholder="6ìë¦¬ ì½”ë“œ" required>
                    <button type="button" class="btn btn-outline-primary" onclick="verifyCode()">ì¸ì¦í™•ì¸</button>
                </div>
                <div id="codeFeedback" class="form-text d-none"></div>
            </div>

            <!-- ìƒˆ ë¹„ë°€ë²ˆí˜¸ -->
            <div class="mb-3">
                <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="newPassword" class="form-control" placeholder="ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ" required>
                <div id="passwordFeedback" class="form-text text-danger d-none">ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            </div>

            <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
            <div class="mb-3">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥" required>
                <div id="passwordMatchFeedback" class="form-text text-danger d-none">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            </div>

            <!-- ì œì¶œ -->
            <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
        </form>

        <div class="mt-3 text-center">
            <a th:href="@{/login}">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>
</div>

<script>
    let emailVerified = false;

    async function sendCode() {
        const email = document.getElementById("email").value.trim();
        const res = await fetch(`/user/find-password/send-code?email=${encodeURIComponent(email)}`, {
            method: "POST"
        });

        const feedback = document.getElementById("emailFeedback");
        if (res.ok) {
            feedback.classList.remove("d-none", "text-danger");
            feedback.classList.add("text-success");
            feedback.textContent = "ì¸ì¦ì½”ë“œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else {
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            feedback.textContent = "ì¸ì¦ì½”ë“œ ì „ì†¡ ì‹¤íŒ¨";
        }
    }

    async function verifyCode() {
        const email = document.getElementById("email").value.trim();
        const code = document.getElementById("code").value.trim();
        const feedback = document.getElementById("codeFeedback");

        const res = await fetch("/user/find-password/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code })
        });

        if (!res.ok) {
            const error = await res.json();
            feedback.classList.remove("d-none", "text-success");
            feedback.classList.add("text-danger");
            feedback.textContent = error.message || "ì¸ì¦ ì‹¤íŒ¨. ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
            return;
        }

        const data = await res.json();
        if (data.data) {
            feedback.classList.remove("d-none", "text-danger");
            feedback.classList.add("text-success");
            feedback.textContent = "ì¸ì¦ ì„±ê³µ!";
            emailVerified = true;
            updateSubmitButtonState();
        }
    }

    function isPasswordValid() {
        const pw = document.getElementById("newPassword").value.trim();
        const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        const valid = regex.test(pw);

        document.getElementById("passwordFeedback").classList.toggle("d-none", valid);
        return valid;
    }

    function isPasswordMatched() {
        const pw = document.getElementById("newPassword").value.trim();
        const confirm = document.getElementById("confirmPassword").value.trim();
        const match = pw === confirm;

        document.getElementById("passwordMatchFeedback").classList.toggle("d-none", match);
        return match;
    }

    function updateSubmitButtonState() {
        const isValid = emailVerified && isPasswordValid() && isPasswordMatched();
        document.getElementById("submitBtn").disabled = !isValid;
    }

    document.getElementById("newPassword").addEventListener("input", updateSubmitButtonState);
    document.getElementById("confirmPassword").addEventListener("input", updateSubmitButtonState);

    document.getElementById("resetForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!emailVerified) {
            alert("ì´ë©”ì¼ ì¸ì¦ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.");
            return;
        }

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("newPassword").value.trim();

        const resetRes = await fetch("/user/find-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });

        if (resetRes.ok) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/login";
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    });
</script>

</body>
</html>